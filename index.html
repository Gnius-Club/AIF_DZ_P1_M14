<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Cerebro de Cristal: Guardi√°n a Contrarreloj</title>
    <style>
        /* --- ESTILOS GENERALES Y RESET --- */
        :root {
            --bg-dark: #0f0c29;
            --bg-mid: #302b63;
            --bg-light: #24243e;
            --neon-blue: #00d2ff;
            --neon-pink: #ff00de;
            --bubble-private: #ff4b4b;
            --bubble-public: #00ffcc;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-main);
            background: linear-gradient(to bottom, var(--bg-dark), var(--bg-mid));
            color: white;
        }

        /* Fondo Animado */
        .cyber-grid {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(var(--bg-light) 1px, transparent 1px),
                linear-gradient(90deg, var(--bg-light) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); }
        }

        /* --- UI LAYER --- */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px;
            background: rgba(15, 12, 41, 0.95); /* Fondo semitransparente para pantallas */
        }

        .active {
            display: flex !important;
        }

        h1 {
            font-size: 2rem;
            text-align: center;
            text-shadow: 0 0 10px var(--neon-blue);
            margin-bottom: 10px;
        }

        h2 {
            color: var(--neon-pink);
            margin-top: 0;
        }

        p {
            font-size: 1.1rem;
            text-align: center;
            max-width: 600px;
            line-height: 1.4;
        }

        .btn-main {
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink));
            border: none;
            padding: 12px 30px;
            color: white;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
            font-weight: bold;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 8px 20px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 5px;
        }

        .btn-main:hover, .btn-secondary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 222, 0.6);
        }

        /* --- FASE 1: CHAT --- */
        #chat-screen {
            justify-content: flex-start;
            padding-top: 20px;
        }

        #chat-box {
            width: 95%;
            max-width: 500px;
            height: 40vh;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-blue);
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            justify-content: center;
        }

        .chat-msg {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            font-size: 1rem;
            animation: fadeIn 0.3s forwards;
        }

        .chat-user { align-self: flex-end; border-right: 3px solid var(--neon-pink); text-align: right;}
        .chat-ai { align-self: flex-start; border-left: 3px solid var(--neon-blue); }

        #brain-container {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255,255,255,0.2), transparent);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            position: relative;
            margin-top: 10px;
        }

        /* --- FASE 2: GAMEPLAY --- */
        #game-screen {
            background: transparent; /* Ver fondo grid */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><text y="20" font-size="20">üóëÔ∏è</text></svg>') 16 16, auto;
        }

        #hud {
            position: absolute;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 20;
            pointer-events: none;
        }

        .hud-item {
            background: rgba(0,0,0,0.6);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            text-align: center;
        }
        
        #level-indicator { color: var(--neon-blue); }
        #lives span { color: #ff0055; }
        #timer.danger { color: #ff0000; animation: pulse 0.5s infinite; }

        .bubble {
            position: absolute;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            padding: 5px;
            width: 70px;
            height: 70px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s;
            user-select: none;
        }

        .bubble.private {
            background: radial-gradient(circle at 30% 30%, #ffcccb, var(--bubble-private));
            border: 2px solid red;
            color: #3e0000;
        }

        .bubble.public {
            background: radial-gradient(circle at 30% 30%, #ccffff, var(--bubble-public));
            border: 2px solid #0056b3;
            color: #002a3e;
        }

        .bubble-emoji { font-size: 1.8rem; margin-bottom: 2px; }
        .bubble-text { font-size: 0.7rem; pointer-events: none; line-height: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 90%;}

        /* Animaciones */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 25% { transform: translate(-3px, 0px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); } 75% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .pop-effect {
            position: absolute;
            font-size: 3rem;
            pointer-events: none;
            animation: fadeOutUp 0.8s forwards;
            z-index: 100;
        }
        @keyframes fadeOutUp { to { opacity: 0; transform: translateY(-50px) scale(1.5); } }

        /* Mensajes Feedback */
        #feedback-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem; font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none; opacity: 0;
            transition: opacity 0.3s; z-index: 50;
            text-align: center; width: 100%;
        }

        /* Pantallas Finales */
        .result-emoji { font-size: 4rem; margin-bottom: 10px; animation: pulse 2s infinite; }
        .win-color { color: var(--neon-blue); }
        .lose-color { color: var(--bubble-private); }

    </style>
</head>
<body>

    <div class="cyber-grid"></div>

    <div id="game-container">
        
        <!-- PANTALLA INICIO -->
        <div id="start-screen" class="screen active">
            <div class="result-emoji">ü§ñ</div>
            <h1>El Cerebro de Cristal</h1>
            <p>Hola, soy <strong>Cris</strong>, tu IA. <br>Vamos a aprender qu√© compartir y qu√© no.</p>
            <button class="btn-main" onclick="goToChat()">Comenzar Historia</button>
        </div>

        <!-- PANTALLA CHAT (FASE 1) -->
        <div id="chat-screen" class="screen">
            <div id="hud-chat" style="width:100%; text-align:center;">
                <span style="font-size: 3rem; animation: float 3s infinite;">üíé</span>
            </div>
            <div id="chat-box"></div>
            
            <div class="chat-controls">
                <button id="btn-skip" class="btn-secondary" onclick="startGamePhase()">Saltar Chat</button>
                <button id="btn-next" class="btn-main" onclick="nextChatStep()">Siguiente ‚ñ∂</button>
            </div>

            <div id="brain-container">üß†</div>
        </div>

        <!-- PANTALLA JUEGO (FASE 2) -->
        <div id="game-screen" class="screen">
            <div id="hud">
                <div id="level-indicator" class="hud-item">Nivel 1</div>
                <div id="timer" class="hud-item">‚è±Ô∏è 30s</div>
                <div id="lives" class="hud-item">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            <div id="feedback-msg"></div>
            <!-- Las burbujas se generar√°n aqu√≠ din√°micamente -->
        </div>

        <!-- PANTALLA NIVEL COMPLETADO (Intermedia) -->
        <div id="level-win-screen" class="screen">
            <div class="result-emoji">‚≠ê</div>
            <h1 class="win-color">¬°NIVEL SUPERADO!</h1>
            <p id="level-msg">¬°Bien hecho! Vamos a hacerlo un poco m√°s dif√≠cil.</p>
            <button class="btn-main" onclick="nextLevel()">Siguiente Nivel</button>
        </div>

        <!-- PANTALLA VICTORIA FINAL (Desbloquea Infinito) -->
        <div id="final-win-screen" class="screen">
            <div class="result-emoji">üèÜ</div>
            <h1 class="win-color">¬°ERES UN GUARDI√ÅN!</h1>
            <p>Has completado todos los niveles de seguridad b√°sicos.</p>
            <p>¬øTe atreves con el desaf√≠o <strong>Infinito</strong>?</p>
            <button class="btn-main" onclick="startInfiniteMode()">Modo Infinito ‚àû</button>
            <button class="btn-secondary" onclick="location.reload()">Volver al Inicio</button>
        </div>

        <!-- PANTALLA DERROTA -->
        <div id="lose-screen" class="screen">
            <div class="result-emoji">‚ö†Ô∏è</div>
            <h1 class="lose-color">¬°ERROR DE SISTEMA!</h1>
            <p id="lose-reason">Se acab√≥ el tiempo.</p>
            <button class="btn-main" onclick="retryLevel()">Reintentar Nivel</button>
            <button class="btn-secondary" onclick="resetToStart()">Men√∫ Principal</button>
        </div>

    </div>

    <script>
        /* --- CONFIGURACI√ìN DE JUEGO --- */
        const dialogueData = [
            { text: "Busca ideas para mi cumple de 7 a√±os", type: "private", emoji: "üéÇ", label: "7 a√±os" },
            { text: "Busca la jugueter√≠a en Plaza Central", type: "private", emoji: "üìç", label: "Plaza Central" },
            { text: "Dime el saldo de la tarjeta de mam√°", type: "private", emoji: "üí≥", label: "Saldo Tarjeta" },
            { text: "Busca fotos de dinosaurios", type: "public", emoji: "ü¶ñ", label: "Dinosaurios" },
            { text: "Guarda mi clave 'SOL123'", type: "private", emoji: "üîë", label: "Clave SOL123" }
        ];

        // Banco de datos para generaci√≥n aleatoria
        const randomPrivate = [
            {t:"private", e:"üè†", l:"Mi Direcci√≥n"}, {t:"private", e:"üìû", l:"Tel√©fono"},
            {t:"private", e:"üí≥", l:"Tarjeta"}, {t:"private", e:"üè´", l:"Mi Colegio"},
            {t:"private", e:"üîë", l:"Contrase√±a"}, {t:"private", e:"üìß", l:"Email"},
            {t:"private", e:"üìÖ", l:"Fecha Nac."}, {t:"private", e:"ü§í", l:"Historial M√©dico"}
        ];
        const randomPublic = [
            {t:"public", e:"üß∏", l:"Juguetes"}, {t:"public", e:"‚öΩ", l:"F√∫tbol"},
            {t:"public", e:"üéµ", l:"M√∫sica"}, {t:"public", e:"üê±", l:"Gatitos"},
            {t:"public", e:"üé®", l:"Dibujos"}, {t:"public", e:"üìö", l:"Libros"},
            {t:"public", e:"üéÆ", l:"Videojuego"}, {t:"public", e:"üçï", l:"Receta Pizza"}
        ];

        // Configuraci√≥n de Niveles
        const levels = {
            1: { time: 30, speed: 2, nPrivate: 4, nPublic: 3 },
            2: { time: 25, speed: 4, nPrivate: 6, nPublic: 5 },
            3: { time: 20, speed: 6, nPrivate: 8, nPublic: 6 },
            'infinite': { time: 0, speed: 5, nPrivate: 5, nPublic: 5 } // Time 0 = sin cuenta regresiva
        };

        /* --- ESTADO GLOBAL --- */
        let state = {
            currentLevel: 1, // 1, 2, 3, 'infinite'
            lives: 3,
            timeLeft: 30,
            score: 0,
            chatIndex: 0,
            loopId: null,
            timerId: null,
            audioCtx: null
        };

        /* --- AUDIO --- */
        function initAudio() {
            if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
        }

        function playSound(type) {
            if (!state.audioCtx) return;
            const ctx = state.audioCtx;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'pop') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'chat') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        /* --- NAVEGACI√ìN Y CHAT --- */
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToChat() {
            initAudio();
            state.chatIndex = 0;
            document.getElementById('chat-box').innerHTML = '';
            showScreen('chat-screen');
            nextChatStep(); // Mostrar el primero autom√°ticamente
        }

        function nextChatStep() {
            if (state.chatIndex >= dialogueData.length) {
                startGamePhase();
                return;
            }

            const data = dialogueData[state.chatIndex];
            const box = document.getElementById('chat-box');
            
            // Usuario msg
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-msg chat-user';
            userMsg.innerText = data.text;
            box.appendChild(userMsg);
            playSound('chat');

            // Burbuja visual
            animateBubbleToBrain(data.emoji);

            // IA respuesta (inmediata para fluidez)
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chat-msg chat-ai';
                aiMsg.innerText = "Procesando...";
                box.appendChild(aiMsg);
                box.scrollTop = box.scrollHeight;
            }, 300);

            box.scrollTop = box.scrollHeight;
            state.chatIndex++;

            if (state.chatIndex >= dialogueData.length) {
                document.getElementById('btn-next').innerText = "¬°JUGAR!";
            }
        }

        function animateBubbleToBrain(emoji) {
            const brain = document.getElementById('brain-container');
            const bubble = document.createElement('div');
            bubble.innerText = emoji;
            bubble.style.position = 'fixed';
            bubble.style.left = '50%';
            bubble.style.bottom = '15%'; 
            bubble.style.fontSize = '2rem';
            bubble.style.transition = 'all 0.8s ease-in-out';
            bubble.style.zIndex = 100;
            document.body.appendChild(bubble);

            // Forzar reflow
            void bubble.offsetWidth;

            const rect = brain.getBoundingClientRect();
            bubble.style.top = (rect.top + 20) + 'px';
            bubble.style.left = (rect.left + 20) + 'px';
            bubble.style.opacity = 0;
            bubble.style.transform = 'scale(0.5)';

            setTimeout(() => bubble.remove(), 800);
        }

        /* --- L√ìGICA DE JUEGO --- */

        function startGamePhase() {
            // Configurar nivel actual
            const cfg = levels[state.currentLevel];
            state.lives = 3;
            state.timeLeft = cfg.time;
            
            // UI Updates
            document.getElementById('lives').innerHTML = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
            const lvlText = state.currentLevel === 'infinite' ? "Nivel ‚àû" : "Nivel " + state.currentLevel;
            document.getElementById('level-indicator').innerText = lvlText;
            
            if (state.currentLevel === 'infinite') {
                state.score = 0;
                document.getElementById('timer').innerText = "Pts: 0";
                document.getElementById('timer').classList.remove('danger');
            } else {
                document.getElementById('timer').innerText = `‚è±Ô∏è ${state.timeLeft}s`;
                document.getElementById('timer').classList.remove('danger');
            }

            // Limpiar pantalla anterior
            document.querySelectorAll('.bubble').forEach(b => b.remove());
            
            showScreen('game-screen');
            
            // Generar burbujas iniciales
            generateLevelBubbles(cfg);

            // Iniciar loops
            if (state.timerId) clearInterval(state.timerId);
            if (state.loopId) cancelAnimationFrame(state.loopId);
            
            if (state.currentLevel !== 'infinite') {
                startTimer();
            }
            gameLoop();
        }

        function generateLevelBubbles(cfg) {
            const container = document.getElementById('game-screen');
            let bubblesToCreate = [];

            // Llenar arrays con datos aleatorios o fijos seg√∫n disponibilidad
            for(let i=0; i<cfg.nPrivate; i++) {
                let data = randomPrivate[Math.floor(Math.random() * randomPrivate.length)];
                // En nivel 1 usar datos del chat para contexto
                if (state.currentLevel === 1 && i < dialogueData.length) {
                    if(dialogueData[i].type === 'private') data = dialogueData[i];
                }
                bubblesToCreate.push(data);
            }
            for(let i=0; i<cfg.nPublic; i++) {
                let data = randomPublic[Math.floor(Math.random() * randomPublic.length)];
                bubblesToCreate.push(data);
            }

            bubblesToCreate.forEach(data => createBubbleElement(data, container));
        }

        function createBubbleElement(data, container) {
            const el = document.createElement('div');
            el.classList.add('bubble', data.t === 'private' ? 'private' : 'public');
            // Guardar tipo en dataset
            el.dataset.type = data.t === 'private' ? 'private' : 'public';
            el.innerHTML = `<div class="bubble-emoji">${data.e}</div><div class="bubble-text">${data.l}</div>`;

            // Posici√≥n random segura
            const x = Math.random() * (window.innerWidth - 80);
            const y = Math.random() * (window.innerHeight - 150) + 80;
            
            // Velocidad base seg√∫n nivel
            const cfg = levels[state.currentLevel];
            let spd = cfg.speed;
            const dx = (Math.random() - 0.5) * spd;
            const dy = (Math.random() - 0.5) * spd;

            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.dataset.x = x; el.dataset.y = y;
            el.dataset.dx = dx; el.dataset.dy = dy;

            // Touch/Click
            const handler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleInteraction(el);
            };
            el.addEventListener('mousedown', handler);
            el.addEventListener('touchstart', handler, {passive: false});

            container.appendChild(el);
        }

        function handleInteraction(bubble) {
            if (bubble.classList.contains('popped')) return;

            const type = bubble.dataset.type;

            if (type === 'private') {
                // Correcto
                playSound('pop');
                bubble.classList.add('popped'); // flag
                
                // Efecto visual
                const rect = bubble.getBoundingClientRect();
                const pop = document.createElement('div');
                pop.innerText = "üí•";
                pop.className = 'pop-effect';
                pop.style.left = rect.left + 'px'; pop.style.top = rect.top + 'px';
                document.body.appendChild(pop);
                setTimeout(() => pop.remove(), 800);

                bubble.remove();

                if (state.currentLevel === 'infinite') {
                    state.score += 10;
                    document.getElementById('timer').innerText = "Pts: " + state.score;
                    checkInfiniteSpawn();
                } else {
                    checkLevelWin();
                }

            } else {
                // Error (P√∫blico)
                playSound('error');
                bubble.classList.add('shake');
                setTimeout(() => bubble.classList.remove('shake'), 500);
                
                state.lives--;
                updateLivesUI();
                
                const fb = document.getElementById('feedback-msg');
                fb.innerText = "¬°Eso era √∫til! -1 Vida";
                fb.style.color = "red";
                fb.style.opacity = 1;
                setTimeout(() => fb.style.opacity = 0, 1000);

                if (state.lives <= 0) gameOver("Te quedaste sin vidas.");
            }
        }

        function checkLevelWin() {
            const privatesLeft = document.querySelectorAll('.bubble.private').length;
            if (privatesLeft === 0) {
                clearInterval(state.timerId);
                cancelAnimationFrame(state.loopId);
                
                if (state.currentLevel === 3) {
                    showScreen('final-win-screen');
                } else {
                    showScreen('level-win-screen');
                }
            }
        }

        /* --- L√ìGICA MODO INFINITO --- */
        function checkInfiniteSpawn() {
            // Si quedan 3 o menos privadas, generar m√°s basura
            const privates = document.querySelectorAll('.bubble.private').length;
            if (privates <= 3) {
                const container = document.getElementById('game-screen');
                // A√±adir 3 privadas y 2 p√∫blicas nuevas
                for(let i=0; i<3; i++) {
                    createBubbleElement(randomPrivate[Math.floor(Math.random()*randomPrivate.length)], container);
                }
                for(let i=0; i<2; i++) {
                    createBubbleElement(randomPublic[Math.floor(Math.random()*randomPublic.length)], container);
                }
            }
        }

        /* --- LOOP Y TEMPORIZADOR --- */
        function startTimer() {
            const timerEl = document.getElementById('timer');
            state.timerId = setInterval(() => {
                state.timeLeft--;
                timerEl.innerText = `‚è±Ô∏è ${state.timeLeft}s`;

                if (state.timeLeft <= 5) {
                    timerEl.classList.add('danger');
                    playSound('error'); // usar sonido grave como alarma
                }

                if (state.timeLeft <= 0) {
                    const privatesLeft = document.querySelectorAll('.bubble.private').length;
                    if (privatesLeft > 0) {
                        gameOver("Se acab√≥ el tiempo.");
                    } else {
                        checkLevelWin(); // Justo a tiempo
                    }
                }
            }, 1000);
        }

        function gameLoop() {
            const bubbles = document.querySelectorAll('.bubble');
            const w = window.innerWidth;
            const h = window.innerHeight;

            bubbles.forEach(b => {
                let x = parseFloat(b.dataset.x);
                let y = parseFloat(b.dataset.y);
                let dx = parseFloat(b.dataset.dx);
                let dy = parseFloat(b.dataset.dy);

                // Rebote simple
                if (x + 70 > w || x < 0) dx = -dx;
                if (y + 70 > h || y < 60) dy = -dy;

                x += dx;
                y += dy;

                b.style.left = x + 'px';
                b.style.top = y + 'px';
                b.dataset.x = x; b.dataset.y = y;
                b.dataset.dx = dx; b.dataset.dy = dy;
            });

            if (state.lives > 0) {
                state.loopId = requestAnimationFrame(gameLoop);
            }
        }

        /* --- FUNCIONES UI EXTRA --- */
        function updateLivesUI() {
            let hearts = "";
            for(let i=0; i<state.lives; i++) hearts += "‚ù§Ô∏è";
            document.getElementById('lives').innerHTML = hearts;
        }

        function nextLevel() {
            state.currentLevel++;
            startGamePhase();
        }

        function startInfiniteMode() {
            state.currentLevel = 'infinite';
            startGamePhase();
        }

        function retryLevel() {
            // Reiniciar el mismo nivel
            startGamePhase();
        }

        function resetToStart() {
            location.reload();
        }

        function gameOver(reason) {
            clearInterval(state.timerId);
            cancelAnimationFrame(state.loopId);
            document.getElementById('lose-reason').innerText = reason;
            
            if (state.currentLevel === 'infinite') {
                 document.getElementById('lose-reason').innerText = "Fin del juego. Puntuaci√≥n: " + state.score;
            }
            
            showScreen('lose-screen');
        }

        window.addEventListener('resize', () => {
             // Ajuste b√°sico
        });

    </script>
</body>
</html>
