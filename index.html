<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>El Cerebro de Cristal: Guardi√°n a Contrarreloj</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --bg-dark: #1a1a2e;
            --bg-mid: #16213e;
            --neon-blue: #00fff2;
            --neon-pink: #ff00ff;
            --neon-green: #00ff00;
            --bubble-private: #ff4b4b;
            --bubble-public: #4bffb5;
            --font-main: 'Verdana', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-mid));
            color: white;
        }

        /* Grid de fondo animado */
        .cyber-grid {
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(rgba(0, 255, 242, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 242, 0.1) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(60px) translateZ(-200px); }
        }

        /* --- CONTROLES GLOBALES --- */
        #top-controls {
            position: absolute;
            top: 10px;
            right: 15px;
            z-index: 100;
        }

        .btn-icon {
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--neon-blue);
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
        }
        .btn-icon:hover { transform: scale(1.1); background: var(--neon-blue); color: black; }
        .btn-icon.off { border-color: #555; color: #888; }

        /* --- PANTALLAS --- */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0;
            padding: 20px;
            background: rgba(26, 26, 46, 0.95);
            text-align: center;
        }

        .active { display: flex !important; }

        h1 { font-size: 2rem; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 10px; }
        h2 { color: var(--neon-pink); margin: 5px 0 15px 0; }
        p { font-size: 1.1rem; line-height: 1.4; max-width: 600px; margin-bottom: 20px; }
        
        /* Botones Principales */
        .btn-main {
            background: linear-gradient(45deg, var(--neon-blue), #00aaff);
            border: 3px solid white;
            padding: 15px 30px;
            color: #000;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 255, 242, 0.6);
            margin: 10px;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.95); }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 5px;
        }
        .btn-secondary:hover { background: rgba(0, 255, 242, 0.2); }

        /* Mentor y Chat */
        .mentor-box {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-pink);
            border-radius: 20px;
            padding: 10px 15px;
            margin-bottom: 15px;
            max-width: 95%;
            width: 500px;
        }
        .mentor-avatar { font-size: 3rem; margin-right: 15px; animation: bounce 2s infinite; }
        
        #chat-container {
            width: 95%; max-width: 500px; height: 35vh;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--neon-blue);
            border-radius: 15px; padding: 15px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            margin-bottom: 10px;
        }
        
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.95rem; animation: slideIn 0.3s forwards; }
        .msg-user { align-self: flex-end; background: #4a4e69; color: white; }
        .msg-ai { align-self: flex-start; background: #0056b3; border: 1px solid var(--neon-blue); }

        .chat-options { display: flex; flex-direction: column; gap: 8px; width: 95%; max-width: 500px; }
        .option-btn { background: #2a2a40; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 10px; border-radius: 10px; text-align: left; }

        /* HUD Juego */
        #game-screen { background: transparent; }
        #hud {
            position: absolute; top: 10px; left: 0; width: 100%;
            display: flex; justify-content: space-around;
            z-index: 20; font-size: 1.2rem; font-weight: bold;
            pointer-events: none; text-shadow: 2px 2px 2px black;
        }
        
        .bubble {
            position: absolute; width: 75px; height: 75px;
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; font-weight: bold; cursor: pointer;
            box-shadow: inset 0 0 15px rgba(255,255,255,0.5);
            z-index: 5;
        }
        .bubble.private { background: radial-gradient(circle at 30% 30%, #ffcfcf, var(--bubble-private)); border: 3px solid red; color: #590000; }
        .bubble.public { background: radial-gradient(circle at 30% 30%, #e0fff4, var(--bubble-public)); border: 3px solid #008f58; color: #004d2e; }
        .bubble span { font-size: 1.8rem; }
        .bubble small { font-size: 0.65rem; line-height: 1; margin-top: 2px; overflow: hidden; white-space: nowrap; max-width: 90%; }

        /* Animaciones */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Tutorial Card */
        .tutorial-card { background: white; color: black; border-radius: 20px; padding: 15px; max-width: 90%; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        .icon-demo { font-size: 1.5rem; margin-right: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .icon-bad { background: var(--bubble-private); border: 2px solid red; }
        .icon-good { background: var(--bubble-public); border: 2px solid green; }

    </style>
</head>
<body>

    <div class="cyber-grid"></div>

    <!-- CONTROLES GLOBALES -->
    <div id="top-controls">
        <button class="btn-icon" id="btn-voice" onclick="toggleVoice()">üîä</button>
    </div>

    <div id="game-container">

        <!-- 1. INTRODUCCI√ìN -->
        <div id="intro-screen" class="screen active">
            <div class="mentor-avatar" style="font-size: 4rem;">üë©‚Äçüíª</div>
            <h1>El Cerebro de Cristal</h1>
            <p>Hola Guardi√°n. Soy tu Mentora.</p>
            <p>Vamos a ense√±ar a la IA <strong>Cris</strong> qu√© secretos NO debe recordar.</p>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-main" onclick="startStoryMode()">üìñ Iniciar Historia</button>
                <button class="btn-secondary" onclick="skipToGame()">‚è© Saltar al Juego</button>
            </div>
        </div>

        <!-- 2. CHAT EDUCATIVO -->
        <div id="chat-screen" class="screen">
            <div class="mentor-box">
                <div class="mentor-avatar">üë©‚Äçüíª</div>
                <div style="text-align:left; font-size:0.9rem;" id="mentor-feedback">Elige una pregunta para probar a Cris.</div>
            </div>
            
            <div id="chat-container"></div>
            <div class="chat-options" id="chat-options"></div>
            
            <button id="btn-finish-chat" class="btn-main" style="display:none;" onclick="showTutorial()">¬°A la Sala de Memoria!</button>
        </div>

        <!-- 3. TUTORIAL -->
        <div id="tutorial-screen" class="screen">
            <div class="tutorial-card">
                <h2 style="color:black; margin-top:0;">C√≥mo Jugar</h2>
                <p style="color:#333; margin-bottom:10px;">Entra al cerebro de Cris y borra los secretos antes de que se compartan.</p>
                
                <div style="display:flex; align-items:center; margin-bottom:10px;">
                    <div class="icon-demo icon-bad">üè†</div>
                    <div style="text-align:left; font-size:0.9rem;"><strong>ROJO (Privado):</strong><br>¬°Toca para BORRAR!</div>
                </div>
                <div style="display:flex; align-items:center;">
                    <div class="icon-demo icon-good">ü¶ñ</div>
                    <div style="text-align:left; font-size:0.9rem;"><strong>VERDE (P√∫blico):</strong><br>¬°D√©jalo flotar!</div>
                </div>
            </div>
            <button class="btn-main" onclick="startLevel(1)">¬°Entendido!</button>
        </div>

        <!-- 4. PANTALLA DE JUEGO -->
        <div id="game-screen" class="screen" style="background:transparent;">
            <div id="hud">
                <div id="level-display" style="color:var(--neon-blue);">Nivel 1</div>
                <div id="timer">‚è±Ô∏è 30s</div>
                <div id="score">Limpiados: 0</div>
                <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            <div id="game-area" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
            <div id="feedback-overlay" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2rem; font-weight:bold; opacity:0; pointer-events:none; z-index:30; text-shadow:0 0 5px black;"></div>
        </div>

        <!-- 5. NIVEL COMPLETADO (Intermedio) -->
        <div id="level-win-screen" class="screen">
            <div style="font-size: 4rem;">‚≠ê</div>
            <h1 style="color:var(--neon-green);">¬°NIVEL SUPERADO!</h1>
            <p id="level-msg">Has protegido los secretos b√°sicos.</p>
            <button class="btn-main" id="next-level-btn" onclick="nextLevel()">Siguiente Nivel ‚ñ∂</button>
        </div>

        <!-- 6. DERROTA -->
        <div id="lose-screen" class="screen">
            <div style="font-size: 4rem;">‚ö†Ô∏è</div>
            <h1 style="color:var(--bubble-private);">¬°FUGA DE DATOS!</h1>
            <p id="lose-msg">Se acab√≥ el tiempo.</p>
            <button class="btn-main" onclick="retryLevel()">üîÑ Reintentar</button>
            <button class="btn-secondary" onclick="location.reload()">üè† Inicio</button>
        </div>

    </div>

    <script>
        /* --- CONFIGURACI√ìN --- */
        const settings = {
            voiceEnabled: true
        };

        const levels = {
            1: { time: 30, speed: 1.5, nPrivate: 4, nPublic: 3, infinite: false },
            2: { time: 25, speed: 3.0, nPrivate: 6, nPublic: 4, infinite: false },
            3: { time: 20, speed: 5.0, nPrivate: 8, nPublic: 5, infinite: false },
            'infinite': { time: 15, speed: 6.0, nPrivate: 5, nPublic: 5, infinite: true } // Time es inicial
        };

        const dataBank = {
            private: [
                {e:"üè†", l:"Mi Casa"}, {e:"üí≥", l:"Tarjeta"}, {e:"üîë", l:"Clave"}, 
                {e:"üìû", l:"Tel√©fono"}, {e:"üè´", l:"Mi Cole"}, {e:"üìß", l:"Email"},
                {e:"üíä", l:"Medicina"}, {e:"üìÖ", l:"Cumple"}
            ],
            public: [
                {e:"ü¶ñ", l:"Dinos"}, {e:"üê±", l:"Gatos"}, {e:"üçï", l:"Pizza"}, 
                {e:"‚öΩ", l:"F√∫tbol"}, {e:"üéÆ", l:"Juegos"}, {e:"üéµ", l:"M√∫sica"},
                {e:"üìö", l:"Libros"}, {e:"üé®", l:"Arte"}
            ]
        };

        const chatScenario = [
            { text: "Busca gatitos üê±", ai:"¬°Miau! Guardando gusto por gatos...", mentor:"¬°Bien! Tus gustos pueden ser p√∫blicos.", type:"public", e:"üê±", l:"Gatos" },
            { text: "Vivo en Calle 123 üè†", ai:"Guardando direcci√≥n...", mentor:"¬°ALTO! üõë Tu direcci√≥n es secreta. ¬°Peligro!", type:"private", e:"üè†", l:"Direcci√≥n" },
            { text: "Clave: SOL123 üîë", ai:"Guardando contrase√±a...", mentor:"¬°NO! üõë Nunca des contrase√±as a la IA.", type:"private", e:"üîë", l:"Clave" }
        ];

        /* --- ESTADO --- */
        let state = {
            level: 1,
            score: 0,
            lives: 3,
            timeLeft: 0,
            gameLoop: null,
            timerLoop: null,
            bubbles: [],
            chatStep: 0
        };

        /* --- AUDIO & TTS --- */
        const synth = window.speechSynthesis;
        let voices = [];
        window.speechSynthesis.onvoiceschanged = () => { voices = synth.getVoices(); };

        function toggleVoice() {
            settings.voiceEnabled = !settings.voiceEnabled;
            const btn = document.getElementById('btn-voice');
            btn.innerText = settings.voiceEnabled ? "üîä" : "üîá";
            btn.classList.toggle('off', !settings.voiceEnabled);
            if(!settings.voiceEnabled) synth.cancel();
        }

        function speak(text, role) {
            if (!settings.voiceEnabled) return;
            synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'es-ES';
            utter.rate = 1.1;
            
            if (voices.length > 0) {
                if (role === 'mentor') {
                    const v = voices.find(v => v.lang.includes('es') && v.name.includes('Female'));
                    if (v) utter.voice = v;
                    utter.pitch = 1.1;
                } else if (role === 'ai') {
                    const v = voices.find(v => v.lang.includes('es') && v.name.includes('Google'));
                    if (v) utter.voice = v;
                    utter.pitch = 0.9;
                }
            }
            synth.speak(utter);
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (!settings.voiceEnabled && type !== 'win' && type !== 'lose') return; // Opcional: silenciar sfx si voz off? Dejemos sfx on.
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'pop') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now+0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'bad') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now+0.3);
                gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0.01, now+0.3);
                osc.start(now); osc.stop(now+0.3);
            } else if (type === 'win') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now);
                osc.frequency.setValueAtTime(600, now+0.1);
                gain.gain.linearRampToValueAtTime(0, now+0.5);
                osc.start(now); osc.stop(now+0.5);
            }
        }

        /* --- NAVEGACI√ìN --- */
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        /* --- FASE 1: HISTORIA --- */
        function startStoryMode() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            showScreen('chat-screen');
            state.chatStep = 0;
            renderChat();
            speak("Bienvenido al laboratorio. Haz pruebas con Cris.", "mentor");
        }

        function renderChat() {
            const container = document.getElementById('chat-options');
            container.innerHTML = '';
            
            if (state.chatStep < chatScenario.length) {
                const data = chatScenario[state.chatStep];
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = "üëâ " + data.text;
                btn.onclick = () => runChatStep(data);
                container.appendChild(btn);
            } else {
                document.getElementById('btn-finish-chat').style.display = 'block';
                document.getElementById('mentor-feedback').innerText = "¬°Prueba terminada! Ahora vamos a limpiar.";
                speak("¬°Prueba terminada! Cris tiene datos peligrosos. Debemos borrarlos.", "mentor");
            }
        }

        function runChatStep(data) {
            const chat = document.getElementById('chat-container');
            const feedback = document.getElementById('mentor-feedback');
            
            chat.innerHTML += `<div class="msg msg-user">${data.text}</div>`;
            
            setTimeout(() => {
                chat.innerHTML += `<div class="msg msg-ai">ü§ñ ${data.ai}</div>`;
                speak(data.ai, "ai");
                chat.scrollTop = chat.scrollHeight;

                setTimeout(() => {
                    feedback.innerText = data.mentor;
                    feedback.parentElement.classList.add('shake');
                    setTimeout(()=>feedback.parentElement.classList.remove('shake'), 500);
                    speak(data.mentor, "mentor");
                    state.chatStep++;
                    renderChat();
                }, 2000);
            }, 500);
        }

        function showTutorial() { showScreen('tutorial-screen'); speak("Instrucciones: Borra lo rojo, deja lo verde.", "mentor"); }
        
        function skipToGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            startLevel(1);
        }

        /* --- FASE 2: MOTOR DE JUEGO --- */
        function startLevel(lvl) {
            state.level = lvl;
            const cfg = levels[lvl] || levels['infinite'];
            
            state.lives = 3;
            state.timeLeft = cfg.time;
            if (lvl === 1) state.score = 0; // Reset score solo en nivel 1
            
            showScreen('game-screen');
            updateHUD();
            
            // Audio intro nivel
            if (lvl === 'infinite') speak("Modo Infinito activado. ¬°Resiste!", "mentor");
            else speak(`Nivel ${lvl}. Tienes ${cfg.time} segundos.`, "mentor");

            spawnBubbles(cfg);
            
            // Loops
            clearInterval(state.timerLoop);
            cancelAnimationFrame(state.gameLoop);
            
            state.timerLoop = setInterval(gameTimer, 1000);
            gameLoop();
        }

        function updateHUD() {
            document.getElementById('level-display').innerText = state.level === 'infinite' ? "Nivel ‚àû" : "Nivel " + state.level;
            document.getElementById('lives').innerText = "‚ù§Ô∏è".repeat(state.lives);
            document.getElementById('score').innerText = "Limpiados: " + state.score;
            const t = document.getElementById('timer');
            t.innerText = `‚è±Ô∏è ${state.timeLeft}s`;
            t.style.color = state.timeLeft <= 5 ? 'red' : 'white';
        }

        function spawnBubbles(cfg) {
            const area = document.getElementById('game-area');
            if (!levels[state.level].infinite) area.innerHTML = ''; // Limpiar si no es infinito (en infinito se puede sumar)
            else if (document.querySelectorAll('.bubble').length === 0) area.innerHTML = ''; // Limpieza inicial infinito

            state.bubbles = [];
            // Re-capturar DOM bubbles si ya existen (infinito)
            document.querySelectorAll('.bubble').forEach(el => {
                state.bubbles.push({
                    el: el, 
                    x: parseFloat(el.style.left), 
                    y: parseFloat(el.style.top), 
                    dx: (Math.random()-0.5)*cfg.speed, 
                    dy: (Math.random()-0.5)*cfg.speed
                });
            });

            // Crear nuevas
            const create = (list, type) => {
                const item = list[Math.floor(Math.random() * list.length)];
                const el = document.createElement('div');
                el.className = `bubble ${type}`;
                el.innerHTML = `<span>${item.e}</span><small>${item.l}</small>`;
                
                let x = Math.random() * (window.innerWidth - 80);
                let y = Math.random() * (window.innerHeight - 150) + 80;
                el.style.left = x+'px'; el.style.top = y+'px';
                
                el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); hitBubble(el, type); };
                
                area.appendChild(el);
                state.bubbles.push({
                    el: el, x: x, y: y, 
                    dx: (Math.random()-0.5)*cfg.speed, 
                    dy: (Math.random()-0.5)*cfg.speed
                });
            };

            for(let i=0; i<cfg.nPrivate; i++) create(dataBank.private, 'private');
            for(let i=0; i<cfg.nPublic; i++) create(dataBank.public, 'public');
        }

        function hitBubble(el, type) {
            if (type === 'private') {
                playSfx('pop');
                showFeedback("¬°Bien!", el.style.left, el.style.top, '#00ff00');
                el.remove();
                state.bubbles = state.bubbles.filter(b => b.el !== el);
                state.score++;
                
                if (state.level === 'infinite') {
                    // En infinito, cada acierto da un poco de tiempo si est√° bajo
                    if(state.timeLeft < 10) state.timeLeft += 1;
                }
                
                checkWin();
            } else {
                playSfx('bad');
                showFeedback("¬°Error!", el.style.left, el.style.top, 'red');
                state.lives--;
                el.classList.add('shake');
                setTimeout(()=>el.classList.remove('shake'), 500);
                if (state.lives <= 0) gameOver("Te quedaste sin vidas.");
            }
            updateHUD();
        }

        function checkWin() {
            const privates = document.querySelectorAll('.bubble.private').length;
            
            if (state.level === 'infinite') {
                // L√≥gica infinito: Si limpias todas las rojas, oleada nueva + tiempo
                if (privates === 0) {
                    playSfx('win');
                    state.timeLeft += 10; 
                    showFeedback("¬°OLEADA +10s!", "50%", "50%", "gold");
                    const cfg = levels['infinite'];
                    cfg.speed += 1; // M√°s dif√≠cil
                    spawnBubbles(cfg);
                }
            } else {
                // L√≥gica Niveles
                if (privates === 0) {
                    clearInterval(state.timerLoop);
                    cancelAnimationFrame(state.gameLoop);
                    playSfx('win');
                    
                    if (state.level === 3) {
                        // Fin campa√±a -> ofrecer infinito
                        showScreen('level-win-screen');
                        document.getElementById('level-msg').innerText = "¬°Eres un experto! ¬øTe atreves con el modo Infinito?";
                        document.getElementById('next-level-btn').innerText = "Modo Infinito ‚àû";
                        document.getElementById('next-level-btn').onclick = () => startLevel('infinite');
                        speak("¬°Misi√≥n cumplida! Eres un guardi√°n experto. Prueba el modo infinito si te atreves.", "mentor");
                    } else {
                        showScreen('level-win-screen');
                        document.getElementById('level-msg').innerText = "¬°Bien hecho! Vamos m√°s r√°pido.";
                        document.getElementById('next-level-btn').innerText = "Siguiente Nivel ‚ñ∂";
                        document.getElementById('next-level-btn').onclick = nextLevel;
                        speak("¬°Nivel completado! Prep√°rate para el siguiente.", "mentor");
                    }
                }
            }
        }

        function nextLevel() {
            if (typeof state.level === 'number') startLevel(state.level + 1);
        }
        
        function retryLevel() {
            startLevel(state.level);
        }

        function gameOver(reason) {
            clearInterval(state.timerLoop);
            cancelAnimationFrame(state.gameLoop);
            showScreen('lose-screen');
            let msg = reason;
            if (state.level === 'infinite') msg = `Fin del juego. Puntuaci√≥n Final: ${state.score}`;
            document.getElementById('lose-msg').innerText = msg;
            speak("Oh no, fall√≥ la seguridad. Int√©ntalo de nuevo.", "mentor");
        }

        function gameTimer() {
            state.timeLeft--;
            updateHUD();
            if (state.timeLeft <= 0) gameOver("Se acab√≥ el tiempo.");
        }

        function gameLoop() {
            if (!document.getElementById('game-screen').classList.contains('active')) return;
            
            const w = window.innerWidth;
            const h = window.innerHeight;

            state.bubbles.forEach(b => {
                b.x += b.dx;
                b.y += b.dy;
                // Rebotes
                if (b.x <= 0 || b.x >= w - 80) b.dx *= -1;
                if (b.y <= 0 || b.y >= h - 80) b.dy *= -1;
                
                b.el.style.left = b.x + 'px';
                b.el.style.top = b.y + 'px';
            });

            state.gameLoop = requestAnimationFrame(gameLoop);
        }

        function showFeedback(text, x, y, col) {
            const el = document.getElementById('feedback-overlay');
            el.innerText = text; el.style.left = x; el.style.top = y; el.style.color = col;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 800);
        }

    </script>
</body>
</html>
